---
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  return [{ params: { slug: '1-placeholder' } }];
}

const OWNER = import.meta.env.PUBLIC_GITHUB_OWNER ?? "selama1";
const REPO  = import.meta.env.PUBLIC_GITHUB_REPO  ?? "losttrackmusic";
const LABEL = (import.meta.env.PUBLIC_GITHUB_BLOG_LABEL ?? "blog").toLowerCase();
---
<BaseLayout title="Post">
  <article class="max-w-3xl mx-auto prose prose-zinc lg:prose-lg">
    <div id="post"></div>
    <div id="comments" class="not-prose mt-10"></div>
  </article>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

  <script type="module" define:vars={{ OWNER, REPO, LABEL }}>
    const owner = OWNER;
    const repo  = REPO;
    const label = LABEL;

    const container = document.getElementById('post');
    const comments  = document.getElementById('comments');

    const pathSlug = location.pathname.replace(/\/$/, '').split('/').pop();
    const match = pathSlug && pathSlug.match(/^(\d+)/);
    const number = match ? match[1] : null;

    async function loadPost() {
      if (!number) {
        container.innerHTML = '<p class="text-zinc-600">Invalid post URL.</p>';
        return;
      }
      try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/issues/${number}`);
        const post = await res.json();
        if (!res.ok || post.message) throw new Error(post.message || `GitHub API ${res.status}`);

        document.title = post.title + " â€” Lost Track";
        const date = new Date(post.created_at).toLocaleDateString();
        const html = DOMPurify.sanitize(marked.parse(post.body || ''));
        container.innerHTML = `
          <header class="not-prose mb-6">
            <h1 class="text-4xl font-bold">${post.title}</h1>
            <div class="text-xs text-zinc-600">${date}</div>
          </header>
          <div class="prose prose-zinc">${html}</div>
        `;

        const script = document.createElement('script');
        script.src = "https://giscus.app/client.js";
        script.setAttribute('data-repo', 'selama1/losttrackmusic');
        script.setAttribute('data-repo-id', 'R_kgDOPaJYhA');
        script.setAttribute('data-category', 'General');
        script.setAttribute('data-category-id', 'DIC_kwDOPaJYhM4Ct7PV');
        script.setAttribute('data-mapping', 'number');
        script.setAttribute('data-term', String(number));
        script.setAttribute('data-strict', '0');
        script.setAttribute('data-reactions-enabled', '1');
        script.setAttribute('data-emit-metadata', '0');
        script.setAttribute('data-input-position', 'top');
        script.setAttribute('data-theme', 'preferred_color_scheme');
        script.setAttribute('data-lang', 'en');
        script.setAttribute('crossorigin', 'anonymous');
        script.async = true;
        comments.innerHTML = '<h2 class="text-xl font-semibold mb-3">Comments</h2>';
        comments.appendChild(script);
      } catch (e) {
        console.error(e);
        container.innerHTML = `<p class="text-red-600">Failed to load post: ${String(e)}</p>`;
      }
    }

    loadPost();
  </script>
</BaseLayout>
